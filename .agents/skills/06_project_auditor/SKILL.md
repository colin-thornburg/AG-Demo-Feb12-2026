---
name: dbt_project_auditor_gallagher
description: Audit a dbt project against Gallagher Blueprint standards and generate a polished HTML report. Runs as the final demo step to prove AI-generated code follows COE governance.
tools: []
---

## Goal
Scan the current dbt project and produce a single-file HTML audit report that checks compliance with Gallagher's data engineering standards. The report should be visually polished, executive-ready, and openable locally in a browser.

## Required Inputs (ask if missing)
| Parameter       | Description                                    | Example         |
|-----------------|------------------------------------------------|-----------------|
| `source_name`   | dbt source name being audited                  | `raw_acq`       |
| `entity_label`  | Human-readable acquisition name                | `AssuredPartners Demo` |
| `output_path`   | Where to save the HTML report                  | `reports/audit_report.html` |

## Audit Checks to Perform

Read the project files and evaluate each check as PASS, WARN, or FAIL.

### 1. Naming Conventions
Scan all `.sql` files in `models/` and all `.yml` files:
- [ ] All model filenames use `snake_case` (no camelCase, no hyphens)
- [ ] Staging models follow pattern: `stg_{source_name}__*.sql`
- [ ] Mart/fact models follow pattern: `f_*.sql`
- [ ] Source name in `_sources.yml` is `snake_case`
- [ ] All column names in YAML are `snake_case`

### 2. Project Structure
Check directory layout:
- [ ] Sources YAML is in `models/staging/{source_name}/`
- [ ] Staging SQL is in `models/staging/{source_name}/`
- [ ] Mart SQL is in `models/marts/{source_name}/` or `models/marts/`
- [ ] No SQL files in the project root `models/` directory
- [ ] No orphaned SQL files outside the expected directories

### 3. Source Definitions
Read `_sources.yml`:
- [ ] Every raw table has a source definition
- [ ] Source has a `description` field (not empty)
- [ ] Source has `freshness` configuration
- [ ] All tables have at least one documented column

### 4. Staging Standards
For each staging model, read the SQL:
- [ ] Uses `source()` function (not hardcoded table references)
- [ ] Uses `dedupe_latest` macro (not inline ROW_NUMBER)
- [ ] Uses normalization macros where applicable (not inline CASE)
- [ ] Does NOT cast timestamps (no `try_to_timestamp`, `to_timestamp`, `cast(... as timestamp)`)
- [ ] Does NOT use `SELECT *` in the final select (explicit column list)
- [ ] Has explicit column aliasing

### 5. Mart/Fact Standards
For each mart model, read the SQL:
- [ ] Uses `ref()` function (not hardcoded table names)
- [ ] Has `materialized='incremental'` config
- [ ] Has `incremental_strategy='merge'` config
- [ ] Has `unique_key` defined
- [ ] Has incremental filter (`is_incremental()` block)
- [ ] Uses LEFT JOIN (not INNER JOIN) for dimension lookups
- [ ] Calculated fields are null-safe (use `coalesce` or `case when`)

### 6. Testing Coverage
Read all `_*_tests.yml` and `schema.yml` files:
- [ ] Every primary key column has `not_null` + `unique` tests
- [ ] Foreign key relationships use `severity: warn`
- [ ] No flaky tests (no rowcount, no exact-value assertions)
- [ ] Test count: at minimum 2 tests per model (PK tests)

### 7. Documentation
- [ ] Source description exists and mentions acquisition context
- [ ] README or doc file exists describing known data issues
- [ ] At least 50% of columns in YAML have descriptions

### 8. Macro Usage (No Inline Logic)
Scan all staging SQL for anti-patterns:
- [ ] No inline `CASE WHEN` blocks longer than 3 lines (should use normalization macros)
- [ ] No inline `ROW_NUMBER()` window functions (should use `dedupe_latest`)
- [ ] No `TRY_TO_*` cast functions in staging models

## Report Generation

Generate a single HTML file with embedded CSS and JavaScript. The report must:

1. **Work offline** — no external CDN dependencies, all styles inline
2. **Be visually polished** — dark theme, Gallagher navy (#1B2A4A) + dbt orange (#FF694A) color scheme
3. **Show a summary dashboard** at the top with:
   - Overall score (% of checks passing)
   - Pass / Warn / Fail counts with colored badges
   - Project name, entity label, audit timestamp
4. **Show each audit category** as a collapsible section with:
   - Category name and pass rate
   - Individual check results with PASS (green ✓), WARN (yellow ⚠), or FAIL (red ✕)
   - For failures: specific file and line reference plus remediation guidance
5. **Include a "Standards Compliance" summary** at the bottom:
   - "This project was generated by AI using dbt Agent Skills"
   - "Audited against Gallagher Blueprint v1.0 standards"
   - Timestamp of audit

### HTML Template Structure

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dbt Project Audit — {entity_label}</title>
    <style>
        /* DESIGN REQUIREMENTS:
         * - Dark background: #0F172A (deep navy)
         * - Cards: #1E293B
         * - Accent: #FF694A (dbt orange)
         * - Pass: #22C55E (green)
         * - Warn: #F59E0B (amber)  
         * - Fail: #EF4444 (red)
         * - Text: #E2E8F0 (light gray)
         * - Font: system-ui with monospace for file paths
         * - Subtle border-radius on cards
         * - Smooth transitions on collapsible sections
         * - Responsive — works on any screen width
         */
    </style>
</head>
<body>
    <!-- HEADER: Project name, entity, timestamp, overall score -->
    <!-- SUMMARY CARDS: Total checks, Pass count, Warn count, Fail count -->
    <!-- AUDIT CATEGORIES: Collapsible sections with individual checks -->
    <!-- FOOTER: Standards version, generation note -->
</body>
</html>
```

### Visual Design Specifications

**Overall Score Display:**
- Large circular progress indicator or percentage number
- Color: green if >90%, amber if 70-90%, red if <70%
- Font size: 48px+ for the number

**Category Cards:**
- Dark card (#1E293B) on dark background (#0F172A)
- Left border accent: green if all pass, amber if warns, red if fails
- Click to expand/collapse individual checks
- Category pass rate shown as a small badge

**Individual Check Results:**
- ✓ PASS — green (#22C55E) with subtle green-tinted background
- ⚠ WARN — amber (#F59E0B) with subtle amber-tinted background
- ✕ FAIL — red (#EF4444) with subtle red-tinted background
- File paths in monospace font
- Remediation text in smaller, muted font below failures

**Footer:**
- "Audited against Gallagher Blueprint v1.0"
- "Generated by dbt Agent Skills"
- Timestamp
- dbt Labs × Gallagher branding

## How to Perform the Audit

### Step 1: Inventory the project
```bash
find models/ -name "*.sql" -o -name "*.yml" | sort
```
List all model and YAML files.

### Step 2: Read each file
For every `.sql` file, read the contents and check against the relevant standards.
For every `.yml` file, read and validate structure and content.

### Step 3: Score each check
- **PASS**: requirement is fully met
- **WARN**: partially met or minor deviation (e.g., missing description but structure is correct)
- **FAIL**: requirement is violated (e.g., inline CASE instead of macro, no tests on PK)

### Step 4: Generate the HTML
Build the complete HTML string with all results embedded. Write to `{output_path}`.

### Step 5: Report
```
Audit complete. Report saved to: {output_path}
Open in browser: open {output_path}

Summary: {pass_count} passed, {warn_count} warnings, {fail_count} failures
Overall score: {score}%
```

## Error Handling
- If a file can't be read, mark its checks as WARN with note "file not accessible"
- If a directory doesn't exist (e.g., no marts yet), mark those checks as WARN with note "directory not found — run skill 03 first"
- Never crash — the audit must always produce a report, even if incomplete

## What NOT to Do
- Do NOT modify any project files — this is read-only
- Do NOT run dbt commands — this is a static analysis only
- Do NOT require any external dependencies (no npm, no pip)
- Do NOT use external CDN links in the HTML — everything must be inline
- Do NOT produce a partial report — always generate the full HTML even if some checks can't run